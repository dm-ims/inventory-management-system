{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %} Import Stock {% endblock title %}

{% block content %}

<div class="row mb-4">
    <div class="col-md-8">
        <h2 style="color:#464646; font-style: bold; border-bottom: 1px solid #464646;">
            Import Stock from CSV
        </h2>
    </div>
    <div class="col-md-4 text-right">
        <a href="{% url 'inventory' %}" class="btn btn-primary">Back to Inventory</a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Upload CSV File</h5>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="form-group">
                        <label for="csv_file">Select CSV File *</label>
                        <input type="file" class="form-control-file" id="csv_file" name="csv_file" accept=".csv" required onchange="showFileName(this)">
                        <small class="form-text text-muted">CSV file must contain columns: Name, Quantity, Unit Price</small>
                        <div id="file-name-preview" class="mt-2" style="display: none;">
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-file-csv"></i> Selected file: <strong id="file-name-text"></strong>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="skip_header" id="skip_header" checked>
                        <label class="form-check-label" for="skip_header">
                            Skip first row (header row)
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload"></i> Import Stock
                    </button>
                    <a href="{% url 'inventory' %}" class="btn btn-secondary">Cancel</a>
                </form>
            </div>
        </div>
        
        <!-- Instructions -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">CSV Format Instructions</h5>
            </div>
            <div class="card-body">
                <p><strong>Required Columns:</strong></p>
                <ul>
                    <li><strong>Name</strong> - Item name (required, unique)</li>
                    <li><strong>Quantity</strong> - Stock quantity (required, integer)</li>
                    <li><strong>Unit Price</strong> - Price per unit (required, decimal)</li>
                </ul>
                
                <p class="mt-3"><strong>Example CSV:</strong></p>
                <pre class="bg-light p-3">Name,Quantity,Unit Price
Item A,100,25.50
Item B,50,15.75
Item C,200,10.00</pre>
                
                <p class="mt-3"><strong>Notes:</strong></p>
                <ul>
                    <li>If an item with the same name already exists, the quantity will be added to existing stock</li>
                    <li>Column names are case-insensitive and can have spaces</li>
                    <li>Invalid rows will be skipped with error messages</li>
                    <li>Maximum file size: 10MB</li>
                </ul>
                
                <a href="{% url 'export-stock' %}" class="btn btn-sm btn-success mt-2">
                    <i class="fas fa-download"></i> Download Template CSV
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        {% if errors %}
        <div class="card border-danger mb-3">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">Import Errors ({{ errors|length }})</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    {% for error in errors %}
                    <li class="text-danger mb-1"><small>{{ error }}</small></li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
        
        {% if rows_processed %}
        <div class="card border-success mb-3">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Processed Rows ({{ rows_processed|length }})</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    {% for row in rows_processed %}
                    <li class="text-success mb-1"><small>{{ row }}</small></li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function showFileName(input) {
        const fileNamePreview = document.getElementById('file-name-preview');
        const fileNameText = document.getElementById('file-name-text');
        
        if (input.files && input.files[0]) {
            const fileName = input.files[0].name;
            // Update preview box
            if (fileNameText) {
                fileNameText.textContent = fileName;
            }
            if (fileNamePreview) {
                fileNamePreview.style.display = 'block';
            }
        } else {
            if (fileNamePreview) {
                fileNamePreview.style.display = 'none';
            }
        }
    }
    
    // Make function globally available
    window.showFileName = showFileName;
});
</script>

{% endblock content %}
